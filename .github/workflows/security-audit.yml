name: Security Audit

on:
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'contracts/src/**'
      - 'src/**'
      - '**.sol'
  push:
    branches: [ main, master, develop ]
    paths:
      - 'contracts/src/**'
      - 'src/**'
      - '**.sol'

jobs:
  slither-security-scan:
    name: Slither Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Slither
        run: |
          python -m pip install --upgrade pip
          pip install slither-analyzer

      - name: Install jq for JSON processing
        run: sudo apt-get install -y jq

      - name: Run Slither security scan
        id: slither-scan
        run: |
          echo "ðŸ” Running Slither security scan..."
          slither contracts/src/ --config-file slither.config.json --json slither-report.json || true

          # Check if report was generated
          if [ -f "slither-report.json" ]; then
            echo "âœ… Security scan completed. Report saved to slither-report.json"

            # Check for critical/high severity issues
            CRITICAL_COUNT=$(jq '.results.detectors[] | select(.impact == "Critical") | length' slither-report.json 2>/dev/null | grep -v "null" | wc -l || echo "0")
            HIGH_COUNT=$(jq '.results.detectors[] | select(.impact == "High") | length' slither-report.json 2>/dev/null | grep -v "null" | wc -l || echo "0")

            echo "CRITICAL_COUNT=$CRITICAL_COUNT" >> $GITHUB_ENV
            echo "HIGH_COUNT=$HIGH_COUNT" >> $GITHUB_ENV

            if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
              echo "âŒ Found $CRITICAL_COUNT critical and $HIGH_COUNT high severity issues!"
              echo "::error::Found $CRITICAL_COUNT critical and $HIGH_COUNT high severity security issues"
              exit 1
            else
              echo "âœ… No critical or high severity issues found!"
              exit 0
            fi
          else
            echo "âŒ Failed to generate security report"
            exit 1
          fi

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: slither-security-report
          path: slither-report.json

      - name: Create PR comment with security summary
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'slither-report.json';

            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

              // Count issues by severity
              const counts = { Critical: 0, High: 0, Medium: 0, Low: 0, Informational: 0, Optimization: 0 };
              if (report.results && report.results.detectors) {
                report.results.detectors.forEach(detector => {
                  if (detector.impact) {
                    counts[detector.impact] = (counts[detector.impact] || 0) + 1;
                  }
                });
              }

              // Create summary
              let summary = `## ðŸ”’ Security Audit Summary\n\n`;
              summary += `| Severity | Count |\n|----------|-------|\n`;
              summary += `| Critical | ${counts.Critical} |\n`;
              summary += `| High | ${counts.High} |\n`;
              summary += `| Medium | ${counts.Medium} |\n`;
              summary += `| Low | ${counts.Low} |\n`;
              summary += `| Informational | ${counts.Informational} |\n`;
              summary += `| Optimization | ${counts.Optimization} |\n`;

              if (counts.Critical > 0 || counts.High > 0) {
                summary += `\nâŒ **Security Check Failed**: Found ${counts.Critical} critical and ${counts.High} high severity issues.\n`;
                summary += `Please review the security report artifact for details.\n`;
              } else {
                summary += `\nâœ… **Security Check Passed**: No critical or high severity issues found!\n`;
              }

              // Add GitHub Actions link
              summary += `\n[View Full Report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})\n`;

              // Create or update comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(comment =>
                comment.user.login === 'github-actions[bot]' &&
                comment.body.includes('## ðŸ”’ Security Audit Summary')
              );

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: summary
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: summary
                });
              }
            }